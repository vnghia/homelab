docker:
  images:
    remote:
      docker-proxy:
        repo: ghcr.io/wollomatic/socket-proxy
        tag: "1.10.0"
      docker-cli:
        repo: docker
        tag: "28.5.1-cli"
  volumes:
    local:
      docker-proxy-mtls:
        backup: false
services:
  traefik:
    variables:
      DOCKER_PROXY_CA_PATH:
        extract:
          svolume: docker-proxy-mtls
        transform:
          path: ca.crt
      DOCKER_PROXY_SERVER_CERT_PATH:
        extract:
          svolume: docker-proxy-mtls
        transform:
          path: server.crt
      DOCKER_PROXY_SERVER_KEY_PATH:
        extract:
          svolume: docker-proxy-mtls
        transform:
          path: server.pem
    container:
      volumes:
        docker-proxy-mtls:
          path: /etc/traefik/cert/docker-proxy-mtls
          read-only: true
  docker:
    variables:
      PROXY_PORT: 2375
    config:
      traefik:
        proxy:
          name: proxy
          hostname: docker-proxy
          service:
            container: proxy
            port:
              svariable: PROXY_PORT
          tls:
            name: proxy
            certs:
              - cert:
                  svariable: DOCKER_PROXY_SERVER_CERT_PATH
                key:
                  svariable: DOCKER_PROXY_SERVER_KEY_PATH
            mtls:
              cas:
                - svariable: DOCKER_PROXY_CA_PATH
      dagu:
        docker:
          executor:
            run:
              model: cli
          dags:
            start:
              dag:
                params:
                  main:
                    CONTAINERS: ""
              command:
                - "docker"
                - "start"
                - param: CONTAINERS
            stop:
              dag:
                params:
                  main:
                    CONTAINERS: ""
              command:
                - "docker"
                - "stop"
                - param: CONTAINERS
    files:
      file:
        ca:
          bind: false
          path:
            service: traefik
            extract:
              svariable: DOCKER_PROXY_CA_PATH
          content:
            cert: ca-cert
        cert:
          bind: false
          path:
            service: traefik
            extract:
              svariable: DOCKER_PROXY_SERVER_CERT_PATH
          content:
            cert: server-cert
        key:
          bind: false
          path:
            service: traefik
            extract:
              svariable: DOCKER_PROXY_SERVER_KEY_PATH
          content:
            key: server-key
            info: private_pem
    secrets:
      ca-key:
        algorithm: ED25519
      ca-cert:
        key: ca-key
        subject:
          common-name:
            hostname: docker-proxy
          organizational-unit: CA
        is-ca-certificate: true
      server-key:
        algorithm: ED25519
      server-cert:
        ca-key: ca-key
        ca-cert: ca-cert
        key: server-key
        allowed-uses: ["server_auth"]
        subject:
          common-name:
            hostname: docker-proxy
          organizational-unit: SERVER
    containers:
      proxy:
        active: false
        image: docker-proxy
        docker-socket:
          write: false
        envs:
          SP_ALLOWFROM: traefik
          SP_LOGJSON: true
          SP_LOGLEVEL: DEBUG
          SP_PROXYPORT:
            svariable: PROXY_PORT
          SP_ALLOW_GET: ".*"
      cli:
        active: false
        image: docker-cli
        docker-socket:
          write: false

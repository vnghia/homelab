docker:
  images:
    remote:
      docker-proxy:
        repo: ghcr.io/wollomatic/socket-proxy
        tag: "1.10.0"
      docker-cli:
        repo: docker
        tag: "28.5.1-cli"
  volumes:
    local:
      docker-cert:
        backup: false
services:
  docker:
    variables:
      PROXY_PORT: 2375
    config:
      traefik:
        proxy:
          name: proxy
          hostname: docker-proxy
          service:
            container: proxy
            port:
              svariable: PROXY_PORT
      dagu:
        docker:
          executor:
            run:
              model: cli
          dags:
            start:
              dag:
                params:
                  main:
                    CONTAINERS: ""
              command:
                - "docker"
                - "start"
                - param: CONTAINERS
            stop:
              dag:
                params:
                  main:
                    CONTAINERS: ""
              command:
                - "docker"
                - "stop"
                - param: CONTAINERS
    files:
      "":
        ca:
          path:
            extract:
              svolume: docker-cert
            transform:
              path: ca.crt
          content:
            cert: ca-cert
        cert:
          path:
            extract:
              svolume: docker-cert
            transform:
              path: server.crt
          content:
            cert: server-cert
        key:
          path:
            extract:
              svolume: docker-cert
            transform:
              path: server.pem
          content:
            key: server-key
            info: private_pem
    secrets:
      ca-key:
        algorithm: ED25519
      ca-cert:
        key: ca-key
        subject:
          common-name:
            hostname: docker-proxy
          organizational-unit: CA
        is-ca-certificate: true
      server-key:
        algorithm: ED25519
      server-cert:
        ca-key: ca-key
        ca-cert: ca-cert
        key: server-key
        allowed-uses: ["server_auth"]
        subject:
          common-name:
            hostname: docker-proxy
          organizational-unit: SERVER
    containers:
      proxy:
        active: false
        image: docker-proxy
        docker-socket:
          write: false
        envs:
          SP_ALLOWFROM: traefik
          SP_LOGJSON: true
          SP_LOGLEVEL: DEBUG
          SP_PROXYPORT:
            svariable: PROXY_PORT
          SP_ALLOW_GET: ".*"
      cli:
        active: false
        image: docker-cli
        docker-socket:
          write: false

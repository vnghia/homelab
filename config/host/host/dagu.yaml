docker:
  images:
    remote:
      dagu:
        repo: ghcr.io/dagu-org/dagu
        tag: "1.24.7-alpine"
  volumes:
    local:
      dagu-home: {}
      dagu-log: {}
      dagu-config:
        backup: false
services:
  dagu:
    variables:
      DAGU_CONFIG_PATH:
        extract:
          volume: dagu-config
        transform:
          path: config.yaml
      DAGU_DAGS_DIR:
        extract:
          volume: dagu-config
        transform:
          path: dags
      DAGU_DAG_LOG_DIR:
        extract:
          volume: dagu-home
        transform:
          path: logs/dag
    config:
      dags-dir:
        svariable: DAGU_DAGS_DIR
      log-dir:
        svariable: DAGU_DAG_LOG_DIR
      traefik:
        dynamic:
          traefik:
            service:
              port:
                env: DAGU_PORT
      dagu:
        dag:
          dag:
            name: dummy
            steps:
              - name: dummy
                run: ["true"]
    files:
      config:
        path:
          svariable: DAGU_CONFIG_PATH
        content:
          format: yaml
          data:
            headless: true
            paths:
              dagsDir:
                svariable: DAGU_DAGS_DIR
              logDir:
                svariable: DAGU_DAG_LOG_DIR
              dataDir:
                extract:
                  volume: dagu-home
                transform:
                  path: data
              suspendFlagsDir:
                extract:
                  volume: dagu-home
                transform:
                  path: suspend
              adminLogsDir:
                extract:
                  volume: dagu-home
                transform:
                  path: logs/admin
              baseConfig:
                extract:
                  volume: dagu-config
                transform:
                  path: base.yaml
            permissions:
              writeDAGs: false
              runDAGs: true
    secrets:
      username: {}
      password: {}
    container:
      experimental: true
      image: dagu
      command:
        - "start-all"
        - "--config"
        - svariable: DAGU_CONFIG_PATH
      docker-socket:
        write: true
      entrypoint: ["dagu"]
      healthcheck:
        tests:
          - "CMD"
          - "wget"
          - "-q"
          - extract:
              env: DAGU_PORT
            transform:
              string:
                template: "http://localhost:{value}/api/v2/health"
          - "-O"
          - "/dev/null"
        interval: 30s
        timeout: 5s
      tmpfs:
        - /tmp
      volumes:
        dagu-home: /var/lib/dagu
        dagu-log:
          svariable: DAGU_DAG_LOG_DIR
        dagu-config:
          path: /etc/dagu
          read-only: true
      wud:
        template: https://github.com/dagu-org/dagu/releases/tag/v${major}.${minor}.${patch}
        include-suffix: -alpine
        transform: true
      envs:
        DAGU_PORT: 8080
        DAGU_TZ:
          hinfo: timezone
        DAGU_LOG_FORMAT: json
        DAGU_AUTH_BASIC_USERNAME:
          secret: username
        DAGU_AUTH_BASIC_PASSWORD:
          secret: password

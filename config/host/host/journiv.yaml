docker:
  images:
    remote:
      journiv:
        repo: swalabtech/journiv-app
        tag: "0.1.0-beta.17"
  volumes:
    local:
      journiv-data: {}
services:
  kanidm:
    config:
      state:
        systems:
          oauth2:
            journiv:
              display-name: Journiv
              origin-url:
                - service: journiv
                  extract:
                    svariable: OIDC_REDIRECT_URI
              origin-landing:
                hostname: journiv
                record: solar
                scheme: https
              prefer-short-username: true
  journiv:
    variables:
      OIDC_REDIRECT_URI:
        extract:
          hostname: journiv
          record: solar
          scheme: https
        transform:
          string:
            template: "{value}/api/v1/auth/oidc/callback"
    config:
      traefik:
        dynamic:
          traefik:
            record: solar
            service:
              port:
                env: APP_PORT
    databases:
      postgres:
        postgres: {}
      valkey:
        valkey: {}
    secrets:
      key: {}
    container:
      image: journiv
      databases:
        - postgres:
          envs:
            env: DATABASE_URL
            scheme: postgresql
        - valkey:
          envs:
            env: REDIS_URL
        - valkey:
          envs:
            env: CELERY_BROKER_URL
        - valkey:
          envs:
            env: CELERY_RESULT_BACKEND
        - valkey:
          envs:
            env: RATE_LIMIT_STORAGE_URI
            database: 1
      healthcheck: {}
      hosts:
        - record: solar
          hostname: kanidm
      volumes:
        journiv-data: /data
      tmpfs:
        - /tmp
      envs:
        SECRET_KEY:
          secret: key
        DOMAIN_NAME:
          hostname: journiv
          record: solar
        DOMAIN_SCHEME: https
        DB_DRIVER: postgres
        ENVIRONMENT: production
        APP_PORT: 8000
        LOG_LEVEL: INFO
        DISABLE_SIGNUP: true
        OIDC_ENABLED: true
        OIDC_ISSUER:
          extract:
            hostname: kanidm
            record: solar
            scheme: https
          transform:
            string:
              template: "{value}/oauth2/openid/journiv"
        OIDC_CLIENT_ID: journiv
        OIDC_CLIENT_SECRET:
          service: kanidm
          extract:
            export: journiv
        OIDC_REDIRECT_URI:
          svariable: OIDC_REDIRECT_URI
        OIDC_SCOPES: openid email profile
        OIDC_AUTO_PROVISION: true
        MEDIA_ROOT:
          extract:
            volume: journiv-data
          transform:
            path: media
    containers:
      worker:
        inherit:
        command:
          - "celery"
          - "-A"
          - "app.core.celery_app"
          - "worker"
          - "--loglevel=info"
        healthcheck: {}
        wud:
        envs:
          SERVICE_ROLE: celery-worker
      beat:
        inherit:
        command:
          - "celery"
          - "-A"
          - "app.core.celery_app"
          - "worker"
          - "--loglevel=info"
        databases:
          - postgres:
            envs:
              env: DATABASE_URL
              scheme: postgresql
          - valkey:
            envs:
              env: REDIS_URL
          - valkey:
            envs:
              env: CELERY_BROKER_URL
          - valkey:
            envs:
              env: CELERY_RESULT_BACKEND
          - valkey:
            envs:
              env: REDBEAT_REDIS_URL
              database: 2
        healthcheck: {}
        wud:
        envs:
          SERVICE_ROLE: celery-beat

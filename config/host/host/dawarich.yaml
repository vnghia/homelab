docker:
  images:
    remote:
      dawarich:
        repo: freikin/dawarich
        tag: "0.37.3"
  volumes:
    local:
      dawarich-storage: {}
services:
  kanidm:
    config:
      state:
        systems:
          oauth2:
            dawarich:
              display-name: Dawarich
              origin-url:
                - service: dawarich
                  extract:
                    svariable: REDIRECT_URL
              origin-landing:
                hostname: dawarich
                record: solar
                scheme: https
              prefer-short-username: true
              allow-insecure-client-disable-pkce: true
  dawarich:
    variables:
      PORT: 3000
      REDIRECT_URL:
        extract:
          hostname: dawarich
          record: solar
          scheme: https
        transform:
          string:
            template: "{value}/users/auth/openid_connect/callback"
      OAUTH_URL:
        extract:
          hostname: kanidm
          record: solar
          scheme: https
        transform:
          string:
            template: "{value}/oauth2/openid/dawarich"
    config:
      traefik:
        dynamic:
          traefik:
            record: solar
            service:
              port:
                svariable: PORT
    databases:
      postgres:
        postgres:
          image: postgis
      valkey:
        valkey: {}
    keepasses:
      keepass:
        hostname:
          hostname: dawarich
          record: solar
    secrets:
      key: {}
    container:
      image: dawarich
      databases:
        - postgres:
          envs:
            username: DATABASE_USERNAME
            password: DATABASE_PASSWORD
            database: DATABASE_NAME
            host: DATABASE_HOST
            port: DATABASE_PORT
        - valkey:
          envs:
            env: REDIS_URL
            database:
      command:
        - bin/rails
        - server
        - "-p"
        - svariable: PORT
        - "-b"
        - "::"
      healthcheck:
        tests:
          - "CMD"
          - "wget"
          - "--spider"
          - "-q"
          - extract:
              svariable: PORT
            transform:
              string:
                template: "http://localhost:{value}/api/v1/health"
      hosts:
        - record: solar
          hostname: kanidm
      entrypoint: ["web-entrypoint.sh"]
      network:
        bridge:
          vpn: {}
      tmpfs:
        - /tmp
        - /var/app/tmp/cache
        - /var/app/tmp/sockets
      volumes:
        dawarich-storage: /var/app/storage
      wud:
        template: https://github.com/Freika/dawarich/releases/tag/${original}
      envs:
        SELF_HOSTED: true
        STORE_GEODATA: true
        RAILS_ENV: production
        MIN_MINUTES_SPENT_IN_CITY: 60
        APPLICATION_HOSTS:
          hostname: dawarich
          record: solar
        APPLICATION_PROTOCOL: http
        TIME_ZONE:
          hinfo: timezone
        DISABLE_TELEMETRY: true
        SECRET_KEY_BASE:
          secret: key
        RAILS_LOG_TO_STDOUT: true
        PIDFILE: /var/app/tmp/cache/server.pid
        OIDC_CLIENT_ID: dawarich
        OIDC_CLIENT_SECRET:
          service: kanidm
          extract:
            export: dawarich
        OIDC_ISSUER:
          svariable: OAUTH_URL
        OIDC_REDIRECT_URI:
          svariable: REDIRECT_URL
        OIDC_PROVIDER_NAME: Kanidm
        OIDC_AUTO_REGISTER: true
        ALLOW_EMAIL_PASSWORD_REGISTRATION: false
    containers:
      worker:
        inherit:
        command: ["bundle", "exec", "sidekiq"]
        entrypoint: ["sidekiq-entrypoint.sh"]
        healthcheck:
          tests: ["CMD", "pgrep", "-f", "sidekiq"]
        wud:

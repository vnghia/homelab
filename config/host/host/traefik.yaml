docker:
  images:
    remote:
      traefik:
        repo: traefik
        tag: "v3.5.1"
  volumes:
    local:
      traefik-config:
        backup: false
      traefik-cert: {}
      traefik-plugin:
        backup: false
      traefik-data: {}
      traefik-tmp:
        backup: false
services:
  traefik:
    variables:
      CERT_PATH:
        extract:
          volume: traefik-cert
        transform:
          path: acme.json
      CONFIG_PATH:
        volume: traefik-config
      STATIC_PATH:
        extract:
          svariable: CONFIG_PATH
        transform:
          path: static.toml
      API_PATH: /proxy
    config:
      path:
        static:
          svariable: STATIC_PATH
        dynamic:
          extract:
            svariable: CONFIG_PATH
          transform:
            path: dynamic
        api:
          svariable: API_PATH
      acme:
        server: https://acme-v02.api.letsencrypt.org/directory
        storage:
          svariable: CERT_PATH
        disable-checks: false
        require-all-rns: false
        disable-ans-checks: true
        delay-before-checks: 60s
      traefik:
        local:
          name: local
          data:
            ipAllowList:
              sourceRange:
                - "192.168.0.0/16"
                - "fc00::/10"
    container:
      image: traefik
      command:
        - "traefik"
        - "--configFile"
        - svariable: STATIC_PATH
      healthcheck:
        tests: ["CMD", "traefik", "healthcheck", "--ping"]
        interval: 30s
        timeout: 5s
        retries: 5
      labels:
        crowdsec.enable: true
        crowdsec.labels.type: traefik
      network:
        container:
          service: tailscale
          extract:
            cinfo: id
      wud:
        template: https://github.com/traefik/traefik/releases/tag/${original}
        include-prefix: v
      volumes:
        traefik-config:
          path: /etc/traefik/config
          read-only: true
        traefik-cert: /etc/traefik/cert
        traefik-plugin: /plugins-storage
        traefik-data: /data
        traefik-tmp: /tmp

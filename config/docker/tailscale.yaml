images:
  remote:
    tailscale:
      repo: ghcr.io/tailscale/tailscale
      tag: "v1.84.2"
volumes:
  local:
    tailscale-data: {}
services:
  tailscale:
    variables:
      PORT: 48470
    container:
      image: tailscale
      capabilities:
        - NET_ADMIN
      healthcheck:
        tests:
          - "CMD"
          - "wget"
          - "--spider"
          - "-q"
          - "http://localhost:9002/healthz"
        interval: 30s
        timeout: 5s
      network:
        default-bridge: true
        proxy-bridge: true
      ports:
        http-v4:
          internal: 80
          external: 80
          ip: "0.0.0.0"
          protocol: tcp
        http-v6:
          internal: 80
          external: 80
          ip: "::"
          protocol: tcp
        https-v4:
          internal: 443
          external: 443
          ip: "0.0.0.0"
          protocol: tcp
        https-v6:
          internal: 443
          external: 443
          ip: "::"
          protocol: tcp
        h3-v4:
          internal: 444
          external: 443
          ip: "0.0.0.0"
          protocol: udp
        h3-v6:
          internal: 444
          external: 443
          ip: "::"
          protocol: udp
        udp-v4:
          internal: 48470
          external: 48470
          ip: "0.0.0.0"
          protocol: udp
        udp-v6:
          internal: 48470
          external: 48470
          ip: "::"
          protocol: udp
      tmpfs:
        - /tmp
        - /run
      volumes:
        tailscale-data: /var/lib/tailscale
      wud:
        template: https://tailscale.com/changelog
        include-prefix: v
      envs:
        TS_STATE_DIR:
          volume: tailscale-data
        TS_USERSPACE: false
        TS_AUTH_ONCE: true
        TS_ENABLE_HEALTH_CHECK: true
        TS_TAILSCALED_EXTRA_ARGS:
          extract:
            variable: PORT
          transform:
            string:
              template: "--port={value} --no-logs-no-support"

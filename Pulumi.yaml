name: homelab
description: My homelab IaC configuration
runtime:
  name: python
  options:
    virtualenv: .venv
    typechecker: mypy
config:
  pulumi:tags:
    value:
      pulumi:template: python
  docker:
    value:
      platform: amd64
      networks:
        bridge:
          default-bridge: {}
      images:
        tailscale:
          repo: tailscale/tailscale
          tag: "v1.78.3"
        traefik:
          repo: traefik
          tag: "v3.3.2"
        dozzle:
          repo: amir20/dozzle
          tag: "v8.10.4"
      volumes:
        local:
          tailscale-data: {}
          traefik-config: {}
      services:
        tailscale:
          container:
            image: tailscale
            capabilities:
              - NET_ADMIN
            healthcheck:
              tests:
                [
                  "CMD",
                  "wget",
                  "--spider",
                  "-q",
                  "http://localhost:9002/healthz",
                ]
              interval: 1s
              timeout: 5s
            ports:
              httpv4:
                internal: 81
                external: 80
                ip: "0.0.0.0"
              httpv6:
                internal: 81
                external: 80
                ip: "::"
              httpsv4:
                internal: 444
                external: 443
                ip: "0.0.0.0"
              httpsv6:
                internal: 444
                external: 443
                ip: "::"
            tmpfs:
              - "/tmp"
              - "/run"
            networks:
              default-bridge: {}
            volumes:
              tailscale-data: /var/lib/tailscale
            envs:
              TS_STATE_DIR:
                volume: tailscale-data
              TS_USERSPACE: "false"
              TS_AUTH_ONCE: "true"
              TS_ENABLE_HEALTH_CHECK: "true"
        traefik:
          config:
            volume: traefik-config
            provider:
              file: dynamic
            api: "/proxy"
            entrypoint:
              public-http: "public-http"
              private-http: "private-http"
              public-https: "public-https"
              private-https: "private-https"
          container:
            image: traefik
            command:
              - "traefik"
              - "--configFile"
              - volume: traefik-config
                path: static.toml
            network_mode: tailscale
            volumes:
              traefik-config:
                path: /etc/traefik/config
                ro: true
            # healthcheck:
            #   tests: ["CMD", "traefik", "healthcheck", "--ping"]
            #   interval: 1s
            #   timeout: 5s
            #   retries: 5
        dozzle:
          container:
            image: dozzle
            healthcheck:
              tests: ["CMD", "/dozzle", "healthcheck"]
              interval: 3s
              timeout: 30s
              retries: 5
              start_period: 30s
            docker_sock_ro: false
            envs:
              DOZZLE_BASE: /log
              DOZZLE_ENABLE_ACTIONS: "true"
